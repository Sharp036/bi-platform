variables:
  SERVER_IP: $PLAYGROUND_SERVER_IP

stages:
  - build
  - deploy

build:
  image: docker:24
  stage: build
  tags:
    - deployment4docker
  services:
    - name: docker:24-dind
      alias: dockerhost
  variables:
    DOCKER_HOST: tcp://dockerhost:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker build -t datalens-bi:latest .
    - docker save datalens-bi:latest -o datalens-bi.tar
  artifacts:
    paths:
      - datalens-bi.tar
    expire_in: 1 hour
  only:
    refs:
      - main

deploy:
  image: docker:24
  services:
    - name: docker:24-dind
      alias: dockerhost
  stage: deploy
  tags:
    - deployment4docker
  variables:
    DOCKER_HOST: ssh://${SERVER_USER}@${SERVER_IP}
    DOCKER_CLIENT_TIMEOUT: 900
    COMPOSE_HTTP_TIMEOUT: 900
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apk update && apk add openssh-client)'
    - eval $(ssh-agent -s)
    - cat "${ID_RSA}" | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $SERVER_IP > ~/.ssh/known_hosts
  script:
    - apk add --no-cache docker-compose
    - echo "server to deploy is - $SERVER_IP"
    - ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "cd /opt/bi-platform && git pull"
    - docker-compose -f /opt/bi-platform/docker-compose.prod.yml --verbose down --remove-orphans
    - docker-compose -f /opt/bi-platform/docker-compose.prod.yml --verbose up -d --build
  only:
    refs:
      - main