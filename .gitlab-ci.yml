# ══════════════════════════════════════════════
#  DataLens BI — GitLab CI/CD Pipeline
# ══════════════════════════════════════════════

stages:
  - test
  - build
  - deploy

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE/datalens-bi

# ── Cache Gradle dependencies ──
cache:
  key: "${CI_COMMIT_REF_SLUG}-gradle"
  paths:
    - .gradle/caches
    - .gradle/wrapper
    - backend/build

# ── Test ──
test:
  stage: test
  image: gradle:8.10-jdk21
  tags: [deployment4docker] # change according your CI settings
  services:
    - name: postgres:16-alpine
      alias: postgres
      variables:
        POSTGRES_DB: datalens_test
        POSTGRES_USER: datalens
        POSTGRES_PASSWORD: test
  variables:
    DB_HOST: postgres
    DB_PORT: "5432"
    DB_NAME: datalens_test
    DB_USER: datalens
    DB_PASSWORD: test
    JWT_SECRET: test_secret_at_least_32_characters_long_for_jwt
  script:
    - cd backend
    - gradle test --no-daemon
  artifacts:
    reports:
      junit: backend/build/test-results/test/*.xml
    when: always
  rules:
    - if: $CI_MERGE_REQUEST_ID
    - if: $CI_COMMIT_BRANCH == "main"

# ── Build Docker Image ──
build:
  stage: build
  image: docker:24
  tags: [deployment4docker] # change according your CI settings
  services:
    - docker:24-dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA -t $DOCKER_IMAGE:latest .
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_IMAGE:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# ── Deploy (example: docker-compose on server) ──
deploy:
  stage: deploy
  image: alpine:latest
  tags: [deployment4docker] # change according your CI settings
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
  script:
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
        cd /opt/datalens-bi
        docker-compose pull datalens
        docker-compose up -d datalens
        docker image prune -f
      EOF
  environment:
    name: production
    url: https://bi.yourcompany.com
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
